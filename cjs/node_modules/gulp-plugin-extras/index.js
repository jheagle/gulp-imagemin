"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.gulpPlugin = gulpPlugin;
var _index = _interopRequireDefault(require("../easy-transform-stream/index.js"));
var _pluginError = _interopRequireDefault(require("./plugin-error.js"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
function gulpPlugin(name, onFile, {
  onFinish,
  supportsDirectories = false,
  supportsAnyType = false
} = {}) {
  return (0, _index.default)({
    objectMode: true
  }, async file => {
    if (!supportsAnyType) {
      if (file.isNull() && !(supportsDirectories && file.isDirectory())) {
        return file;
      }
      if (file.isStream()) {
        throw new _pluginError.default(name, 'Streaming not supported');
      }
    }
    try {
      return await onFile(file);
    } catch (error) {
      throw new _pluginError.default(name, error, {
        fileName: file.path,
        showStack: true
      });
    }
  }, onFinish && async function* (stream) {
    try {
      yield* onFinish(stream);
    } catch (error) {
      throw new _pluginError.default(name, error, {
        showStack: true
      });
    }
  });
}